#cloud-config
<%#
kind: snippet
name: cloudconfig
oses:
- CoreOS
%>
      coreos:
        fleet:
          metadata: "role=etcd"
        etcd2:
<% if @host.params['peer_address'] != @host.ip -%>
          initial-cluster: master=http://<master-private-ip>:2380
<% end -%>
          advertise-client-urls: http://<%= @host.params['peer_address'] %>:2379
          initial-advertise-peer-urls: http://<%= @host.params['peer_address'] %>
          listen-client-urls: http://0.0.0.0:2379
	        listen-peer-urls: http://0.0.0.0:2380
        units:
          - name: etcd2.service
            command: start
          - name: fleet.socket
            command: start
            content: |
              [Socket]
              ListenStream=4002
              Service=fleet.service
              [Install]
              WantedBy=sockets.target
          - name: fleet.service
            command: start
          - name: etcd-key-for-flannel.service
            command: start
            content: |
              [Unit]
              After=network-online.target
              Requires=network-online.target
              After=etcd.service
              Requires=etcd.service
              Description=flannel is an etcd backed overlay network for containers
              [Service]
              ExecStart=/usr/bin/etcdctl set /coreos.com/network/config '{"Network":"<%= @host.params['overlay_network'] %>", "Backend": {"Type": "vxlan"}}'
              RestartSec=15s
              Restart=on-failure
<% if @host.params['ssh_authorized_keys'] -%>
      ssh_authorized_keys:
  <% @host.params['ssh_authorized_keys'].split(',').map(&:strip).each do |ssh_key| -%>
      - "<%= ssh_key %>"
  <% end -%>
<% end -%>
